name: Debug Test Brid

on: workflow_dispatch

jobs:
  build-core:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y cpu-checker
          kvm-ok
          sudo chown $USER /dev/kvm || true
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rov-src --accept-routes

      - name: Mount Test Container
        run: |
          docker run -d -p 5555:5555 -p 6080:6080 \
            -e EMULATOR_DEVICE="Samsung Galaxy S7" \
            -e WEB_VNC=true \
            -e EMULATOR_ARGS="-memory 8192 -cores 4 -partition-size 24576" \
            --device /dev/kvm \
            --name build-container \
            --privileged \
            budtmo/docker-android:emulator_10.0
          timeout 300s bash -c 'until docker exec build-container adb wait-for-device; do sleep 5; done'
          while true; do sleep 300; done

      - name: Disconnect Tailscale
        if: always()
        run: sudo tailscale logout